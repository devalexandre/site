<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#"><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <title>Moleculer Go - Progressive microservices framework in Go</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="microservices, nodejs, node.js, javascript, github, opensource, framework, moleculer, github, scaling">
  <meta name="description" content="Moleculer is a fast, scalable and powerful microservices framework for Node.js.">
  <meta name="robots" content="index, follow">
  <!-- Canonical links -->
  <link rel="canonical" href="https://gomicro.services/docs/0.1/middlewares.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="en" href="https://gomicro.services/docs/0.1/middlewares.html">
    
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <!-- CSS -->
  <!-- build:css build/css/moleculer.css -->
  <link rel="stylesheet" href="/css/moleculer.css">
  <!-- endbuild -->
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700|Roboto Mono|Lato:300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">
  <!-- RSS
  <link rel="alternate" href="/atom.xml" title="Moleculer Go - Progressive microservices framework in Go">
  -->
  <!-- Open Graph -->
  <meta name="description" content="Middlewares WIP Documentation For MVP we have the basics of MIddelwares working. We already use it for some internal core functions, but the API is not user-friendly yet. We will tackle this soon as w">
<meta property="og:type" content="website">
<meta property="og:title" content="Moleculer Go - Progressive microservices framework in Go">
<meta property="og:url" content="https://gomicro.services/docs/0.1/middlewares.html">
<meta property="og:site_name" content="Moleculer Go - Progressive microservices framework in Go">
<meta property="og:description" content="Middlewares WIP Documentation For MVP we have the basics of MIddelwares working. We already use it for some internal core functions, but the API is not user-friendly yet. We will tackle this soon as w">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://gomicro.services/docs/0.1/assets/under_construction.png">
<meta property="og:image" content="https://gomicro.services/docs/0.1/assets/middlewares.svg">
<meta property="og:updated_time" content="2019-04-22T02:46:01.745Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Moleculer Go - Progressive microservices framework in Go">
<meta name="twitter:description" content="Middlewares WIP Documentation For MVP we have the basics of MIddelwares working. We already use it for some internal core functions, but the API is not user-friendly yet. We will tackle this soon as w">
<meta name="twitter:image" content="https://gomicro.services/docs/0.1/assets/under_construction.png">
<meta name="twitter:site" content="MoleculerG">
  <!-- Google Analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99099811-1', 'auto');
  ga('send', 'pageview');
</script>


  <!-- Particles -->
  <script src="/js/buttons.js"></script>

</head>

<body>
  <div id="particles-js"></div>
  <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <h1 id="logo-wrap">
      <a href="/" id="logo">Moleculer</a>
    </h1>
    <nav id="main-nav">
      <a href="/docs/0.1/" class="main-nav-link">Documentation</a><a href="/modules.html" class="main-nav-link">Modules</a><a href="/support.html" class="main-nav-link">Support</a>
      <a href="https://github.com/moleculer-go/moleculer" class="main-nav-link">Github</a>
      <a href="https://gitter.im/moleculer-go/moleculer" class="main-nav-link">Chat</a>
      <div id="search-input-wrap" class="on">
        <div id="search-input-icon">
          <i class="fa fa-search"></i>
        </div>
        <input type="search" id="search-input" placeholder="Search...">
      </div>
    </nav>
    <div id="lang-select-wrap" style="display: none">
      <label id="lang-select-label"><i class="fa fa-globe"></i><span>English</span></label>
      <select id="lang-select" data-canonical="">
        
          <option value="en" selected>English</option>
        
      </select>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

  <div id="container">
    <div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <article class="article-container" itemscope="" itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <div class="article-content" itemprop="articleBody">
                <a href="https://github.com/moleculer-go/site/edit/master/source/docs/0.1/middlewares.md" class="corner-right article-edit-link" title="Improve this doc"><i class="fa fa-pencil"></i></a>
                <h1 id="Middlewares" class="article-heading"><a href="#Middlewares" class="headerlink" title="Middlewares"></a>Middlewares<a class="article-anchor" href="#Middlewares" aria-hidden="true"></a></h1><hr>
<blockquote class="note info"><strong class="note-title">WIP Documentation</strong><p><img src="assets/under_construction.png" width="150/"></p>
<p>For MVP we have the basics of MIddelwares working. We already use it for some internal core functions, but the API is not user-friendly yet. We will tackle this soon as we develop more plugins that require middlewares.</p>
<p>This documentation is still a working in progress and this page has not been fully converted yet :(</p>
<p>We are working on top of the existing Moleculer JS documentation, and that is why you might see pages with some JavaScript :)</p>
</blockquote>
<p>Moleculer supports middlewares. The middleware is an <code>Object</code> with hooks &amp; wrapper functions. Wrap action handlers, event handlers, broker methods and hook lifecycle events.</p>
<p><strong>All available methods:</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MyCustomMiddleware = &#123;</span><br><span class="line">    <span class="comment">// Wrap local action handlers (legacy middleware handler)</span></span><br><span class="line">    localAction(next, action) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// Change context properties or something</span></span><br><span class="line">            <span class="keyword">return</span> next(ctx)</span><br><span class="line">                .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="comment">// Do something with the response</span></span><br><span class="line">                    <span class="keyword">return</span> res;</span><br><span class="line">                &#125;)</span><br><span class="line">                .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="comment">// Handle error or throw further</span></span><br><span class="line">                    <span class="keyword">throw</span> err;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap remote action calling</span></span><br><span class="line">    remoteAction(next, action) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// Change context properties or something</span></span><br><span class="line">            <span class="keyword">return</span> next(ctx)</span><br><span class="line">                .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="comment">// Do something with the response</span></span><br><span class="line">                    <span class="keyword">return</span> res;</span><br><span class="line">                &#125;)</span><br><span class="line">                .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="comment">// Handle error or throw further</span></span><br><span class="line">                    <span class="keyword">throw</span> err;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap local event handlers</span></span><br><span class="line">    localEvent(next, event) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">payload, sender, eventName</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// Change payload or something</span></span><br><span class="line">            <span class="keyword">return</span> next(payload, sender, eventName);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap broker.createService method</span></span><br><span class="line">    createService(next) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">schema, schemaMods</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"The 'createService' is called."</span>);</span><br><span class="line">            <span class="keyword">return</span> next(schema, schemaMods);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap broker.destroyService method</span></span><br><span class="line">    destroyService(next) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">service</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"The 'destroyService' is called."</span>);</span><br><span class="line">            <span class="keyword">return</span> next(service);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap broker.call method</span></span><br><span class="line">    call(next) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">actionName, params, opts</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"The 'call' is called."</span>, eventName);</span><br><span class="line">            <span class="keyword">return</span> next(actionName, params, opts).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"Response:"</span>, res);</span><br><span class="line">                <span class="keyword">return</span> res;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap broker.mcall method</span></span><br><span class="line">    mcall(next) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"The 'call' is called."</span>, eventName);</span><br><span class="line">            <span class="keyword">return</span> next(...arguments).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"Response:"</span>, res);</span><br><span class="line">                <span class="keyword">return</span> res;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap broker.emit method</span></span><br><span class="line">    emit(next) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">eventName, payload, groups</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"The 'emit' is called."</span>, eventName);</span><br><span class="line">            <span class="keyword">return</span> next(eventName, payload, groups);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap broker.broadcast method</span></span><br><span class="line">    broadcast(next) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">eventName, payload, groups</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"The 'broadcast' is called."</span>, eventName);</span><br><span class="line">            <span class="keyword">return</span> next(eventName, payload, groups);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wrap broker.broadcastLocal method</span></span><br><span class="line">    broadcastLocal(next) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">eventName, payload, groups</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"The 'broadcastLocal' is called."</span>, eventName);</span><br><span class="line">            <span class="keyword">return</span> next(eventName, payload, groups);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After a new local service created (sync)</span></span><br><span class="line">    serviceCreated(service) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Service created"</span>, service.name);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before a local service started (async)</span></span><br><span class="line">    serviceStarting(service) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Service is starting"</span>, service.name);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After a local service started (async)</span></span><br><span class="line">    serviceStarted(service) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Service started"</span>, service.name);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before a local service stopping (async)</span></span><br><span class="line">    serviceStopping(service) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Service is stopping"</span>, service.name);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After a local service stopped (async)</span></span><br><span class="line">    serviceStopped(service) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Service stopped"</span>, service.name);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After broker is created (async)</span></span><br><span class="line">    created(broker) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Broker created"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before broker starting (async)</span></span><br><span class="line">    starting(broker) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Broker is starting"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After broker started (async)</span></span><br><span class="line">    started(broker) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Broker started"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before broker stopping (async)</span></span><br><span class="line">    stopping(broker) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Broker is stopping"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After broker stopped (async)</span></span><br><span class="line">    stopped(broker) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Broker stopped"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Wrapping-handlers" class="article-heading"><a href="#Wrapping-handlers" class="headerlink" title="Wrapping handlers"></a>Wrapping handlers<a class="article-anchor" href="#Wrapping-handlers" aria-hidden="true"></a></h2><p>Some hooks are wrappers. It means you must wrap the original handler and return a new Function.<br>Wrap hooks where the first parameter is <code>next</code>.</p>
<p><strong>Wrap local action handler</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MyDoSomethingMiddleware = &#123;</span><br><span class="line">    localAction(next, action) &#123;</span><br><span class="line">        <span class="keyword">if</span> (action.myFunc) &#123;</span><br><span class="line">            <span class="comment">// Wrap the handler</span></span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">                doSomethingBeforeHandler(ctx);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> handler(ctx)</span><br><span class="line">                    .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                        doSomethingAfterHandler(res);</span><br><span class="line">                        <span class="comment">// Return the original result</span></span><br><span class="line">                        <span class="keyword">return</span> res;</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                        doSomethingAfterHandlerIfFailed(err);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Throw further the error</span></span><br><span class="line">                        <span class="keyword">throw</span> err;</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the feature is disabled we don't wrap it, return the original handler</span></span><br><span class="line">        <span class="comment">// So it won't cut down the performance at calling where the feature is disabled.</span></span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>Example validator middleware</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MyValidator = &#123;</span><br><span class="line">    localAction(next, action) &#123;</span><br><span class="line">        <span class="comment">// Wrap with a param validator if `action.params` is defined</span></span><br><span class="line">        <span class="keyword">if</span> (_.isObject(action.params)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.validate(action.params, ctx.params);</span><br><span class="line">                <span class="keyword">return</span> next(ctx);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The <code>next</code> is the original handler or the following wrapped handler. The middleware should return either the original <code>handler</code> or a new wrapped handler. As you can see above, we check whether the action has a <code>params</code> props. If yes, we’ll return a wrapped handler which calls the validator module before calling the original <code>handler</code>.<br>If the <code>params</code> property is not defined, we will return the original <code>handler</code> (skipped wrapping).</p>
<blockquote>
<p>If you don’t call the original <code>next</code> in the middleware it will break the request. It can be used in cachers. For example, if it finds the requested data in the cache, it’ll return the cached data instead of calling the <code>next</code>.</p>
</blockquote>
<p><strong>Example cacher middleware</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MyCacher = &#123;</span><br><span class="line">    localAction(next, action) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">cacherMiddleware</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">const</span> cacheKey = <span class="keyword">this</span>.getCacheKey(</span><br><span class="line">                action.name,</span><br><span class="line">                ctx.params,</span><br><span class="line">                action.cache.keys</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">const</span> content = <span class="keyword">this</span>.get(cacheKey);</span><br><span class="line">            <span class="keyword">if</span> (content != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Found in the cache! Don't call next, return with the cached content</span></span><br><span class="line">                ctx.cachedResult = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(content);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Call the next</span></span><br><span class="line">            <span class="keyword">return</span> next(ctx).then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// Afterwards save the response to the cache</span></span><br><span class="line">                <span class="keyword">this</span>.set(cacheKey, result);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;.bind(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The <code>next</code> always returns a <code>Promise</code>. So you can access to responses and manipulate them, as well.</p>
</blockquote>
<h3 id="Decorate-core-modules-extend-functionality" class="article-heading"><a href="#Decorate-core-modules-extend-functionality" class="headerlink" title="Decorate core modules (extend functionality)"></a>Decorate core modules (extend functionality)<a class="article-anchor" href="#Decorate-core-modules-extend-functionality" aria-hidden="true"></a></h3><p>With other hooks are help you to add new features to <code>ServiceBroker</code> &amp; <code>Service</code>.</p>
<p><strong>Decorate broker with a new <code>allCall</code> method</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> broker = <span class="keyword">new</span> ServiceBroker(&#123;</span><br><span class="line">    middlewares: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// After broker is created</span></span><br><span class="line">            created(broker) &#123;</span><br><span class="line">                <span class="comment">// Call action on all available nodes</span></span><br><span class="line">                broker.allCall = <span class="function"><span class="keyword">function</span>(<span class="params">action, params, opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">const</span> nodeIDs = <span class="keyword">this</span>.registry</span><br><span class="line">                        .getNodeList(&#123; <span class="attr">onlyAvailable</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">                        .map(<span class="function"><span class="params">node</span> =&gt;</span> node.id);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Make direct call to the given Node ID</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">                        nodeIDs.map(<span class="function"><span class="params">nodeID</span> =&gt;</span></span><br><span class="line">                            broker.call(</span><br><span class="line">                                action,</span><br><span class="line">                                params,</span><br><span class="line">                                <span class="built_in">Object</span>.assign(&#123; nodeID &#125;, opts)</span><br><span class="line">                            )</span><br><span class="line">                        )</span><br><span class="line">                    );</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> broker.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Call `$node.health` on every nodes &amp; collect results</span></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> broker.allCall(<span class="string">"$node.health"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Internal-middlewares" class="article-heading"><a href="#Internal-middlewares" class="headerlink" title="Internal middlewares"></a>Internal middlewares<a class="article-anchor" href="#Internal-middlewares" aria-hidden="true"></a></h2><p>Many integrated features have been exposed to internal middlewares. These middlewares are loaded by default when broker is created. It can be turned off with the <code>internalMiddlewares: false</code> in broker option. In this case you must add what you need in the <code>middlewares: []</code> broker option.</p>
<p><strong>Internal middlewares</strong></p>
<table>
<thead>
<tr>
<th>Class name</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ActionHook</code></td>
<td>Optional</td>
<td>Action hooks handler. <a href="actions.html#Action-hooks">Read more</a></td>
</tr>
<tr>
<td>Validator</td>
<td>Optional</td>
<td>Parameter validation. <a href="validating.html">Read more</a></td>
</tr>
<tr>
<td><code>Bulkhead</code></td>
<td>Optional</td>
<td>Bulkhead feature. <a href="fault-tolerance.html#Bulkhead">Read more</a></td>
</tr>
<tr>
<td>Cacher</td>
<td>Optional</td>
<td>Cacher middleware. <a href="caching.html">Read more</a></td>
</tr>
<tr>
<td><code>ContextTracker</code></td>
<td>Optional</td>
<td>Context tracker feature. <a href="actions.html#Context-tracking">Read more</a></td>
</tr>
<tr>
<td><code>CircuitBreaker</code></td>
<td>Optional</td>
<td>Circuit Breaker feature. <a href="fault-tolerance.html#Circuit-Breaker">Read more</a></td>
</tr>
<tr>
<td><code>Timeout</code></td>
<td>Always</td>
<td>Timeout feature. <a href="fault-tolerance.html#Timeout">Read more</a></td>
</tr>
<tr>
<td><code>Retry</code></td>
<td>Always</td>
<td>Retry feature. <a href="fault-tolerance.html#Retry">Read more</a></td>
</tr>
<tr>
<td><code>Fallback</code></td>
<td>Always</td>
<td>Fallback feature. <a href="fault-tolerance.html#Fallback">Read more</a></td>
</tr>
<tr>
<td><code>ErrorHandler</code></td>
<td>Always</td>
<td>Error handling.</td>
</tr>
<tr>
<td><code>Metrics</code></td>
<td>Optional</td>
<td>Metrics feature. <a href="metrics.html">Read more</a></td>
</tr>
</tbody>
</table>
<p><strong>Access to internal middlewares</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Bulkhead, Retry &#125; = <span class="built_in">require</span>(<span class="string">"moleculer"</span>).Middlewares;</span><br></pre></td></tr></table></figure>
<div align="center"><br><img src="assets/middlewares.svg" alt="Middlewares diagram"><br></div>

              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2019-04-22T02:46:01.745Z" itemprop="dateModified">Last updated: 2019-04-22</time>
                <a href="logging.html" class="article-footer-prev" title="Logging"><i class="fa fa-chevron-left"></i><span>Prev</span></a><a href="networking.html" class="article-footer-next" title="Networking"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
              
            </div>
          </div>
          <aside id="article-toc" role="navigation">
            <div id="article-toc-inner">
              <strong class="sidebar-title">Contents</strong>
              <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Middlewares"><span class="toc-text">Middlewares</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Wrapping-handlers"><span class="toc-text">Wrapping handlers</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Decorate-core-modules-extend-functionality"><span class="toc-text">Decorate core modules (extend functionality)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Internal-middlewares"><span class="toc-text">Internal middlewares</span></a></li></ol></li></ol>
              <a href="#" id="article-toc-top">Back to Top</a>
            </div>
          </aside>
        </div>
      </article>
      <aside id="sidebar" role="navigation">
  <div class="inner"><div class="version-selector"><select onchange="changeVersion(this)"><option value="docs/0.1" selected>v0.1</option></select></div><strong class="sidebar-title">Introduction</strong><a href="/docs/0.1/index.html" class="sidebar-link">What is Moleculer?</a><a href="/docs/0.1/usage.html" class="sidebar-link">Usage</a><a href="/docs/0.1/examples.html" class="sidebar-link">Examples</a><strong class="sidebar-title">Overview</strong><a href="/docs/0.1/broker.html" class="sidebar-link">Broker</a><a href="/docs/0.1/services.html" class="sidebar-link">Services</a><a href="/docs/0.1/actions.html" class="sidebar-link">Actions</a><a href="/docs/0.1/events.html" class="sidebar-link">Events</a><a href="/docs/0.1/lifecycle.html" class="sidebar-link">Lifecycles</a><a href="/docs/0.1/logging.html" class="sidebar-link">Logging</a><a href="/docs/0.1/middlewares.html" class="sidebar-link current">Middlewares</a><a href="/docs/0.1/networking.html" class="sidebar-link">Networking</a><a href="/docs/0.1/registry.html" class="sidebar-link">Discovery & Registry</a><a href="/docs/0.1/balancing.html" class="sidebar-link">Load balancing</a><a href="/docs/0.1/fault-tolerance.html" class="sidebar-link">Fault tolerance</a><a href="/docs/0.1/caching.html" class="sidebar-link">Caching</a><a href="/docs/0.1/validating.html" class="sidebar-link">Validating</a><a href="/docs/0.1/metrics.html" class="sidebar-link">Metrics & Tracing</a><a href="/docs/0.1/errors.html" class="sidebar-link">Errors</a><a href="/docs/0.1/runner.html" class="sidebar-link">Moleculer Runner</a><strong class="sidebar-title">Modules</strong><a href="/docs/0.1/moleculer-web.html" class="sidebar-link">API Gateway</a><a href="/docs/0.1/moleculer-repl.html" class="sidebar-link">REPL console</a><a href="/docs/0.1/moleculer-cli.html" class="sidebar-link">CLI Tool</a><a href="/docs/0.1/moleculer-db.html" class="sidebar-link">DB Adapters</a><a href="/modules.html" class="sidebar-link">All modules</a><strong class="sidebar-title">Miscellaneous</strong><a href="/docs/0.1/clustering.html" class="sidebar-link">Clustering</a><a href="/docs/0.1/deploying.html" class="sidebar-link">Deploying</a><a href="/docs/0.1/benchmark.html" class="sidebar-link">Benchmark</a><a href="/docs/0.1/faq.html" class="sidebar-link">FAQ</a><a href="/docs/0.1/contributing.html" class="sidebar-link">Contributing</a><strong class="sidebar-title">API</strong><a href="/docs/0.1/api/service-broker.html" class="sidebar-link">ServiceBroker</a><a href="/docs/0.1/api/service.html" class="sidebar-link">Service</a><a href="/docs/0.1/api/context.html" class="sidebar-link">Context</a><a href="/docs/0.1/api/protocol.html" class="sidebar-link">Protocol</a></div>
</aside>
    </div>
  </div>
</div>

    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      Copyright &copy; 2018-2019 <a href="https://github.com/pentateu" target="_blank">MoleculerGO</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>.
    </div>
    <div id="footer-links">
      <a href="https://gitter.im/moleculer-go/moleculer" class="footer-link" target="_blank"><i class="fa fa-comments-o"></i></a>
      <a href="https://twitter.com/MoleculerG" class="footer-link" target="_blank"><i class="fa fa-twitter"></i></a>
      <a href="https://github.com/moleculer-go/moleculer" class="footer-link" target="_blank"><i class="fa fa-github-alt"></i></a>
      <a href="https://stackoverflow.com/questions/tagged/moleculer-go" class="footer-link" target="_blank"><i class="fa fa-stack-overflow"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/docs/0.1/" class="mobile-nav-link">Documentation</a><a href="/modules.html" class="mobile-nav-link">Modules</a><a href="/support.html" class="mobile-nav-link">Support</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/moleculer-go/moleculer" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
      <div class="version-selector"><select onchange="changeVersion(this)"><option value="docs/0.1" selected>v0.1</option></select></div><strong class="mobile-nav-title">Introduction</strong><a href="/docs/0.1/index.html" class="mobile-nav-link">What is Moleculer?</a><a href="/docs/0.1/usage.html" class="mobile-nav-link">Usage</a><a href="/docs/0.1/examples.html" class="mobile-nav-link">Examples</a><strong class="mobile-nav-title">Overview</strong><a href="/docs/0.1/broker.html" class="mobile-nav-link">Broker</a><a href="/docs/0.1/services.html" class="mobile-nav-link">Services</a><a href="/docs/0.1/actions.html" class="mobile-nav-link">Actions</a><a href="/docs/0.1/events.html" class="mobile-nav-link">Events</a><a href="/docs/0.1/lifecycle.html" class="mobile-nav-link">Lifecycles</a><a href="/docs/0.1/logging.html" class="mobile-nav-link">Logging</a><a href="/docs/0.1/middlewares.html" class="mobile-nav-link current">Middlewares</a><a href="/docs/0.1/networking.html" class="mobile-nav-link">Networking</a><a href="/docs/0.1/registry.html" class="mobile-nav-link">Discovery & Registry</a><a href="/docs/0.1/balancing.html" class="mobile-nav-link">Load balancing</a><a href="/docs/0.1/fault-tolerance.html" class="mobile-nav-link">Fault tolerance</a><a href="/docs/0.1/caching.html" class="mobile-nav-link">Caching</a><a href="/docs/0.1/validating.html" class="mobile-nav-link">Validating</a><a href="/docs/0.1/metrics.html" class="mobile-nav-link">Metrics & Tracing</a><a href="/docs/0.1/errors.html" class="mobile-nav-link">Errors</a><a href="/docs/0.1/runner.html" class="mobile-nav-link">Moleculer Runner</a><strong class="mobile-nav-title">Modules</strong><a href="/docs/0.1/moleculer-web.html" class="mobile-nav-link">API Gateway</a><a href="/docs/0.1/moleculer-repl.html" class="mobile-nav-link">REPL console</a><a href="/docs/0.1/moleculer-cli.html" class="mobile-nav-link">CLI Tool</a><a href="/docs/0.1/moleculer-db.html" class="mobile-nav-link">DB Adapters</a><a href="/modules.html" class="mobile-nav-link">All modules</a><strong class="mobile-nav-title">Miscellaneous</strong><a href="/docs/0.1/clustering.html" class="mobile-nav-link">Clustering</a><a href="/docs/0.1/deploying.html" class="mobile-nav-link">Deploying</a><a href="/docs/0.1/benchmark.html" class="mobile-nav-link">Benchmark</a><a href="/docs/0.1/faq.html" class="mobile-nav-link">FAQ</a><a href="/docs/0.1/contributing.html" class="mobile-nav-link">Contributing</a><strong class="mobile-nav-title">API</strong><a href="/docs/0.1/api/service-broker.html" class="mobile-nav-link">ServiceBroker</a><a href="/docs/0.1/api/service.html" class="mobile-nav-link">Service</a><a href="/docs/0.1/api/context.html" class="mobile-nav-link">Context</a><a href="/docs/0.1/api/protocol.html" class="mobile-nav-link">Protocol</a>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en" selected>English</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- build:js build/js/main.js -->
<script src="/js/lang_select.js"></script>
<script src="/js/version_select.js"></script>
<script src="/js/scrollingelement.js"></script>
<script src="/js/toc.js"></script>
<script src="/js/mobile_nav.js"></script>
<!-- endbuild -->
<script src="https://cdn.jsdelivr.net/retinajs/1.3.0/retina.min.js" async></script>

<!-- Algolia -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
apiKey: '7d5514b7c3e161a428f04f33ba1bdab4',
indexName: 'moleculer',
inputSelector: '#search-input',
algoliaOptions: { 'facetFilters': ["version:0.1"] },
debug: false // Set debug to true if you want to inspect the dropdown
});
</script>


<!-- fastclick -->
<script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  FastClick.attach(document.body)
}, false)
</script>

<!-- Gitter Chat -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'moleculer-go/moleculer'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
</body>
</html>